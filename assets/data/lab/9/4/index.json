{"hash":"67914fd947c86ec6cef518fc9b753f3d959daea2","data":{"labInstructions":{"id":"9-4","step":4,"lab":9,"title":"Lab 9","content":"<h1 id=\"save-and-load-from-firebase\"><a href=\"#save-and-load-from-firebase\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Save and Load from Firebase.</h1>\n<p>Now that we have a working Sketchbook and a logged in user, we need to save that sketch for the user to Firebase.</p>\n<p>First we have to get the user from storage. Firebase provides a simple function to do that:</p>\n<pre><code>// Create a global user variable\nvar user;\n\n// We need to wait for firebase to check the login.\nfirebase.auth().onAuthStateChanged(function(udata) {\n    if (udata) {\n      // User is signed in.\n      user = udata;\n      initApp();\n    } else {\n      // User is not logged in, send back to login page\n      window.location.assign(\"/\");\n    }\n});\n</code></pre>\n<p>You notice in the code above that we use an initApp() function. This is what we will create next. We need to wrap the app initialization into a function because we need to wait for firebase to see if there is a logged in user or not.</p>\n<p>Now create the initApp() function:</p>\n<p>This function will need to do a couple of things. It will need to see if there is a document for the user yet, if there is load the data from it, otherwise just init the Konva canvas with no data.</p>\n<pre><code>var db = firebase.firestore();\nvar docRef;\nfunction initApp() {\n    docRef = db.collection(\"sketches\").doc(user.email);\n\n    docRef.get().then(function(doc) {\n        if (doc.exists) {\n            console.log(\"Loaded Saved Data\");\n            initKonva(doc.data().sketch);\n        } else {\n            console.log(\"Loaded New Sketch\");\n            initKonva();\n        }\n    }).catch(function(error) {\n        console.log(\"Error getting document:\", error);\n    });\n}\n</code></pre>\n<p>Now our initKonva function needs a small tweak so it loads the data.</p>\n<pre><code>function initKonva(jdata) {\n      \n      if(jdata) {\n        stage = Konva.Node.create(jdata, 'sketchBook');\n      } else {\n        stage = new Konva.Stage({\n            container: 'sketchBook',\n            width: width,\n            height: height\n        });\n      }\n\n      ... rest of code\n</code></pre>\n<p>Once we have that setup we will need to save the data when the save button is clicked. To do that we will define a new save function:</p>\n<pre><code>function saveSketch(evt) {\n    evt.preventDefault();\n    console.log(\"Saved Sketch\");\n    var sk = stage.toJSON();\n    docRef.set({\n        sketch: sk\n    }).then(function() {\n        console.log(\"Document Saved\");\n    })\n}\n</code></pre>\n<p>This function should be called when the save button is clicked.</p>\n","path":"/lab/9/4/","start":false,"last":false}},"context":{}}
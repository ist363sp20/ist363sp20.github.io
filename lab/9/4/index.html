<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Lab 9 - IST 363 - Advanced Web Development</title><meta name="gridsome:hash" content="67914fd947c86ec6cef518fc9b753f3d959daea2"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.12"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.9cf0f6d81cc06611e2b31acc39ba41b4.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.9cf0f6d81cc06611e2b31acc39ba41b4.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.9cf0f6d81cc06611e2b31acc39ba41b4.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.9cf0f6d81cc06611e2b31acc39ba41b4.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="152x152" href="/assets/static/favicon.62d22cb.9cf0f6d81cc06611e2b31acc39ba41b4.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="120x120" href="/assets/static/favicon.1539b60.9cf0f6d81cc06611e2b31acc39ba41b4.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="167x167" href="/assets/static/favicon.dc0cdc5.9cf0f6d81cc06611e2b31acc39ba41b4.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="180x180" href="/assets/static/favicon.7b22250.9cf0f6d81cc06611e2b31acc39ba41b4.png"><link data-vue-tag="ssr" rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"><link data-vue-tag="ssr" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css"><link rel="preload" href="/assets/css/0.styles.cb6d46c9.css" as="style"><link rel="preload" href="/assets/js/app.83620269.js" as="script"><link rel="preload" href="/assets/js/page--src-templates-lab-instructions-vue.07b3e787.js" as="script"><link rel="prefetch" href="/assets/js/page--node-modules-gridsome-app-pages-404-vue.36003f05.js"><link rel="prefetch" href="/assets/js/page--src-pages-about-vue.44668dd2.js"><link rel="prefetch" href="/assets/js/page--src-pages-index-vue.e351a5f4.js"><link rel="prefetch" href="/assets/js/page--src-pages-project-vue.014484b9.js"><link rel="prefetch" href="/assets/js/page--src-pages-schedule-vue.f3d13047.js"><link rel="prefetch" href="/assets/js/page--src-pages-weeks-vue.8f2768f0.js"><link rel="prefetch" href="/assets/js/page--src-templates-week-schedule-vue.474a94cf.js"><link rel="stylesheet" href="/assets/css/0.styles.cb6d46c9.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body >
    <div data-server-rendered="true" id="app" data-v-0c39e30d><div data-app="true" id="ist-v-app" class="v-application v-application--is-ltr theme--light" data-v-0c39e30d><div class="v-application--wrap"><nav class="v-navigation-drawer v-navigation-drawer--clipped v-navigation-drawer--close v-navigation-drawer--fixed v-navigation-drawer--is-mobile theme--light" style="height:100vh;top:0px;transform:translateX(-100%);width:256px;" data-v-0c39e30d><div class="v-navigation-drawer__content"><img src="/logo.svg" class="logo" data-v-0c39e30d><div class="v-list v-sheet v-sheet--tile theme--light v-list--dense" data-v-0c39e30d><a href="/" tabindex="0" class="v-list-item v-list-item--link theme--light" data-v-0c39e30d><div class="v-list-item__action" data-v-0c39e30d><i aria-hidden="true" class="v-icon notranslate mdi mdi-home theme--light" data-v-0c39e30d></i></div><div class="v-list-item__content" data-v-0c39e30d><div class="v-list-item__title" data-v-0c39e30d>Home</div></div></a><a href="/schedule/" tabindex="0" class="v-list-item v-list-item--link theme--light" data-v-0c39e30d><div class="v-list-item__action" data-v-0c39e30d><i aria-hidden="true" class="v-icon notranslate mdi mdi-calendar theme--light" data-v-0c39e30d></i></div><div class="v-list-item__content" data-v-0c39e30d><div class="v-list-item__title" data-v-0c39e30d>Course Schedule</div></div></a><a href="/weeks/" tabindex="0" class="v-list-item v-list-item--link theme--light" data-v-0c39e30d><div class="v-list-item__action" data-v-0c39e30d><i aria-hidden="true" class="v-icon notranslate mdi mdi-briefcase-clock theme--light" data-v-0c39e30d></i></div><div class="v-list-item__content" data-v-0c39e30d><div class="v-list-item__title" data-v-0c39e30d>Weekly Agenda</div></div></a><a href="/project/" tabindex="0" class="v-list-item v-list-item--link theme--light" data-v-0c39e30d><div class="v-list-item__action" data-v-0c39e30d><i aria-hidden="true" class="v-icon notranslate mdi mdi-briefcase-clock theme--light" data-v-0c39e30d></i></div><div class="v-list-item__content" data-v-0c39e30d><div class="v-list-item__title" data-v-0c39e30d>Course Project</div></div></a><div tabindex="0" class="v-list-item v-list-item--link theme--light" data-v-0c39e30d><div class="v-list-item__action" data-v-0c39e30d><i aria-hidden="true" class="v-icon notranslate mdi mdi-bookmark theme--light" data-v-0c39e30d></i></div><div class="v-list-item__content" data-v-0c39e30d><div class="v-list-item__title" data-v-0c39e30d>Syllabus</div></div></div><a href="/about/" tabindex="0" class="v-list-item v-list-item--link theme--light" data-v-0c39e30d><div class="v-list-item__action" data-v-0c39e30d><i aria-hidden="true" class="v-icon notranslate mdi mdi-account theme--light" data-v-0c39e30d></i></div><div class="v-list-item__content" data-v-0c39e30d><div class="v-list-item__title" data-v-0c39e30d>About the Instructor</div></div></a></div></div><div class="v-navigation-drawer__border"></div></nav><header class="v-sheet v-sheet--tile theme--dark v-toolbar v-app-bar v-app-bar--clipped v-app-bar--fixed primary" style="height:64px;margin-top:0px;transform:translateY(0px);left:0px;right:0px;" data-v-0c39e30d><div class="v-toolbar__content" style="height:64px;"><button type="button" class="v-app-bar__nav-icon v-btn v-btn--flat v-btn--icon v-btn--round theme--dark v-size--default" data-v-0c39e30d><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-menu theme--dark" data-v-0c39e30d></i></span></button><div class="v-toolbar__title" data-v-0c39e30d>IST 363 - Advanced Web Development</div></div></header><main class="v-content" style="padding-top:3392px;padding-right:0px;padding-bottom:0px;padding-left:0px;" data-v-0c39e30d><div class="v-content__wrap"><div class="container container--fluid fill-height" data-v-417dbc17 data-v-0c39e30d><div class="lab-intructions" data-v-417dbc17><h2 class="accent--text" data-v-417dbc17>Lab 9 step 4</h2><div class="lab-instructions-content" data-v-417dbc17><h1 id="save-and-load-from-firebase"><a href="#save-and-load-from-firebase" aria-hidden="true"><span class="icon icon-link"></span></a>Save and Load from Firebase.</h1>
<p>Now that we have a working Sketchbook and a logged in user, we need to save that sketch for the user to Firebase.</p>
<p>First we have to get the user from storage. Firebase provides a simple function to do that:</p>
<pre><code>// Create a global user variable
var user;

// We need to wait for firebase to check the login.
firebase.auth().onAuthStateChanged(function(udata) {
    if (udata) {
      // User is signed in.
      user = udata;
      initApp();
    } else {
      // User is not logged in, send back to login page
      window.location.assign("/");
    }
});
</code></pre>
<p>You notice in the code above that we use an initApp() function. This is what we will create next. We need to wrap the app initialization into a function because we need to wait for firebase to see if there is a logged in user or not.</p>
<p>Now create the initApp() function:</p>
<p>This function will need to do a couple of things. It will need to see if there is a document for the user yet, if there is load the data from it, otherwise just init the Konva canvas with no data.</p>
<pre><code>var db = firebase.firestore();
var docRef;
function initApp() {
    docRef = db.collection("sketches").doc(user.email);

    docRef.get().then(function(doc) {
        if (doc.exists) {
            console.log("Loaded Saved Data");
            initKonva(doc.data().sketch);
        } else {
            console.log("Loaded New Sketch");
            initKonva();
        }
    }).catch(function(error) {
        console.log("Error getting document:", error);
    });
}
</code></pre>
<p>Now our initKonva function needs a small tweak so it loads the data.</p>
<pre><code>function initKonva(jdata) {
      
      if(jdata) {
        stage = Konva.Node.create(jdata, 'sketchBook');
      } else {
        stage = new Konva.Stage({
            container: 'sketchBook',
            width: width,
            height: height
        });
      }

      ... rest of code
</code></pre>
<p>Once we have that setup we will need to save the data when the save button is clicked. To do that we will define a new save function:</p>
<pre><code>function saveSketch(evt) {
    evt.preventDefault();
    console.log("Saved Sketch");
    var sk = stage.toJSON();
    docRef.set({
        sketch: sk
    }).then(function() {
        console.log("Document Saved");
    })
}
</code></pre>
<p>This function should be called when the save button is clicked.</p>
</div><!----><!----></div><div class="actions" data-v-417dbc17><a href="/lab/9/3" class="v-btn v-btn--contained v-btn--rounded v-btn--router theme--dark v-size--default secondary" data-v-417dbc17><span class="v-btn__content">Go to step 3 </span></a><a href="/lab/9/5" class="v-btn v-btn--contained v-btn--rounded v-btn--router theme--dark v-size--default secondary" data-v-417dbc17><span class="v-btn__content">Go to step 5 </span></a></div></div></div></main><footer class="v-footer v-sheet v-sheet--tile theme--light v-footer--fixed primary" style="left:0px;right:0px;bottom:0px;" data-v-0c39e30d><span class="white--text" data-v-0c39e30d>Nick Lyga - Syracuse University © 2019</span></footer></div></div></div>
    <script>window.__INITIAL_STATE__={"data":{"labInstructions":{"id":"9-4","step":4,"lab":9,"title":"Lab 9","content":"\u003Ch1 id=\"save-and-load-from-firebase\"\u003E\u003Ca href=\"#save-and-load-from-firebase\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003ESave and Load from Firebase.\u003C\u002Fh1\u003E\n\u003Cp\u003ENow that we have a working Sketchbook and a logged in user, we need to save that sketch for the user to Firebase.\u003C\u002Fp\u003E\n\u003Cp\u003EFirst we have to get the user from storage. Firebase provides a simple function to do that:\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode\u003E\u002F\u002F Create a global user variable\nvar user;\n\n\u002F\u002F We need to wait for firebase to check the login.\nfirebase.auth().onAuthStateChanged(function(udata) {\n    if (udata) {\n      \u002F\u002F User is signed in.\n      user = udata;\n      initApp();\n    } else {\n      \u002F\u002F User is not logged in, send back to login page\n      window.location.assign(\"\u002F\");\n    }\n});\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EYou notice in the code above that we use an initApp() function. This is what we will create next. We need to wrap the app initialization into a function because we need to wait for firebase to see if there is a logged in user or not.\u003C\u002Fp\u003E\n\u003Cp\u003ENow create the initApp() function:\u003C\u002Fp\u003E\n\u003Cp\u003EThis function will need to do a couple of things. It will need to see if there is a document for the user yet, if there is load the data from it, otherwise just init the Konva canvas with no data.\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode\u003Evar db = firebase.firestore();\nvar docRef;\nfunction initApp() {\n    docRef = db.collection(\"sketches\").doc(user.email);\n\n    docRef.get().then(function(doc) {\n        if (doc.exists) {\n            console.log(\"Loaded Saved Data\");\n            initKonva(doc.data().sketch);\n        } else {\n            console.log(\"Loaded New Sketch\");\n            initKonva();\n        }\n    }).catch(function(error) {\n        console.log(\"Error getting document:\", error);\n    });\n}\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003ENow our initKonva function needs a small tweak so it loads the data.\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode\u003Efunction initKonva(jdata) {\n      \n      if(jdata) {\n        stage = Konva.Node.create(jdata, 'sketchBook');\n      } else {\n        stage = new Konva.Stage({\n            container: 'sketchBook',\n            width: width,\n            height: height\n        });\n      }\n\n      ... rest of code\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EOnce we have that setup we will need to save the data when the save button is clicked. To do that we will define a new save function:\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode\u003Efunction saveSketch(evt) {\n    evt.preventDefault();\n    console.log(\"Saved Sketch\");\n    var sk = stage.toJSON();\n    docRef.set({\n        sketch: sk\n    }).then(function() {\n        console.log(\"Document Saved\");\n    })\n}\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EThis function should be called when the save button is clicked.\u003C\u002Fp\u003E\n","path":"\u002Flab\u002F9\u002F4\u002F","start":false,"last":false}},"context":{}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script><script src="/assets/js/app.83620269.js" defer></script><script src="/assets/js/page--src-templates-lab-instructions-vue.07b3e787.js" defer></script>
  </body>
</html>
